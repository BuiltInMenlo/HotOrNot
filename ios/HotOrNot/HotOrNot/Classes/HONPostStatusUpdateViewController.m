//
//  HONPostStatusUpdateViewController.m
//  HotOrNot
//
//  Created by Anirudh Agarwala on 9/4/14.
//  Copyright (c) 2014 Built in Menlo, LLC. All rights reserved.
//

#import "NSString+DataTypes.h"

#import "CKRefreshControl.h"
#import "KeychainItemWrapper.h"
#import "MBProgressHUD.h"

#import "HONPostStatusUpdateViewController.h"
#import "HONHeaderView.h"

@interface HONPostStatusUpdateViewController ()
@property (nonatomic, strong) UIRefreshControl *refreshControl;
@property (nonatomic, strong) MBProgressHUD *progressHUD;
@property (nonatomic, strong) HONHeaderView *headerView;
@property (nonatomic, strong) UITextView *emojiTextView;
@property (nonatomic) BOOL isSubmitting;
@property (nonatomic) NSUInteger offset;
@property (nonatomic, strong) UILabel *composePlaceholder;
@end

@implementation HONPostStatusUpdateViewController

- (id)init {
	if ((self = [super init])) {
		_offset = 0;
    }
	
    return (self);
}


#pragma mark - Data Calls
- (void)_submitStatusUpdate {
	_progressHUD = [MBProgressHUD showHUDAddedTo:[[UIApplication sharedApplication] delegate].window animated:YES];
	_progressHUD.labelText = NSLocalizedString(@"hud_submit", @"Submittingâ€¦");
	_progressHUD.mode = MBProgressHUDModeIndeterminate;
	_progressHUD.minShowTime = kHUDTime;
	_progressHUD.taskInProgress = YES;
	
	NSMutableArray *emojis = [NSMutableArray array];
	for (int i=0; i<[_emojiTextView.text length]; i+=2)
		[emojis addObject:[_emojiTextView.text substringWithRange:NSMakeRange(i, 2)]];
	
	
	[[HONAnalyticsParams sharedInstance] trackEvent:@"Compose View - Submit Update"
									  withCharArray:emojis];
	
	NSError *error;
	NSString *jsonString = [[NSString alloc] initWithData:[NSJSONSerialization dataWithJSONObject:emojis options:0 error:&error]
												 encoding:NSUTF8StringEncoding];
	
	NSDictionary *submitParams = @{@"user_id"		: [[HONAppDelegate infoForUser] objectForKey:@"id"],
								   @"img_url"		: [[HONClubAssistant sharedInstance] defaultClubPhotoURL],
								   @"club_id"		: [@"" stringFromInt:[[HONClubAssistant sharedInstance] userSignupClub].clubID],
								   @"owner_id"		: [@"" stringFromInt:[[HONClubAssistant sharedInstance] userSignupClub].ownerID],
								   @"subject"		: @"",
								   @"subjects"		: jsonString,
								   @"challenge_id"	: @"0",
								   @"recipients"	: @"",
								   @"api_endpt"		: kAPICreateChallenge};
	NSLog(@"SUBMIT PARAMS:[%@]", submitParams);
	[[NSUserDefaults standardUserDefaults] setValue:emojis forKey:@"last_emojis"];
	[[NSUserDefaults standardUserDefaults] synchronize];
	
	[[HONAPICaller sharedInstance] submitClubPhotoWithDictionary:submitParams completion:^(NSDictionary *result) {
		if ([[result objectForKey:@"result"] isEqualToString:@"fail"]) {
			if (_progressHUD == nil)
				_progressHUD = [MBProgressHUD showHUDAddedTo:[[UIApplication sharedApplication] delegate].window animated:YES];
			_progressHUD.minShowTime = kHUDTime;
			_progressHUD.mode = MBProgressHUDModeCustomView;
			_progressHUD.customView = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"hudLoad_fail"]];
			_progressHUD.labelText = @"Error!";
			[_progressHUD show:NO];
			[_progressHUD hide:YES afterDelay:kHUDErrorTime];
			_progressHUD = nil;
		
		} else {
			[[HONAPICaller sharedInstance] notifyToCreateImageSizesForPrefix:[[HONClubAssistant sharedInstance] defaultClubPhotoURL]
															   forBucketType:HONS3BucketTypeSelfies
																  completion:nil];
			
			if (_progressHUD != nil) {
				[_progressHUD hide:YES];
				_progressHUD = nil;
			}
			
			[[HONAPICaller sharedInstance] notifyToCreateImageSizesForPrefix:[[HONClubAssistant sharedInstance] defaultClubPhotoURL]
															   forBucketType:HONS3BucketTypeSelfies
																  completion:nil];

			
			UIAlertView *alertView = [[UIAlertView alloc] initWithTitle: @"Confirm your moji update:"
																message: [NSString stringWithFormat:@"%@%@", [_emojiTextView.text substringToIndex:MIN([_emojiTextView.text length], 42)], ([_emojiTextView.text length] > 42) ? @"..." : @""]
															   delegate:self
													  cancelButtonTitle:@"Cancel"
													  otherButtonTitles:@"Send to all contacts", @"Send to all moji friends", nil, nil];
			[alertView setTag:1];
			[alertView show];
			
		}
	}];
}



#pragma mark - View Lifecycle
- (void)loadView {
	ViewControllerLog(@"[:|:] [%@ loadView] [:|:]", self.class);
	[super loadView];
	
	_isSubmitting = NO;
	
	_headerView = [[HONHeaderView alloc] initWithTitle:@"Compose"];
	[self.view addSubview:_headerView];
	
	UIButton *cancelButton = [UIButton buttonWithType:UIButtonTypeCustom];
	cancelButton.frame = CGRectMake(0.0, 19.0, 44.0, 44.0);
	[cancelButton setBackgroundImage:[UIImage imageNamed:@"closeButton_nonActive"] forState:UIControlStateNormal];
	[cancelButton setBackgroundImage:[UIImage imageNamed:@"closeButton_Active"] forState:UIControlStateHighlighted];
	[cancelButton addTarget:self action:@selector(_goCancel) forControlEvents:UIControlEventTouchUpInside];
	[_headerView addSubview:cancelButton];
	
	UIButton *submitButton = [UIButton buttonWithType:UIButtonTypeCustom];
	submitButton.frame = CGRectMake([UIScreen mainScreen].bounds.size.width - 40.0, 1.0, 44.0, 44.0);
	[submitButton setBackgroundImage:[UIImage imageNamed:@"arrowButton_nonActive"] forState:UIControlStateNormal];
	[submitButton setBackgroundImage:[UIImage imageNamed:@"arrowButton_Active"] forState:UIControlStateHighlighted];
	[submitButton addTarget:self action:@selector(_goSubmit) forControlEvents:UIControlEventTouchUpInside];
	[_headerView addButton:submitButton];
	
	
	_composePlaceholder = [[UILabel alloc] initWithFrame:CGRectMake(17.0, 81.0, 304.0, 42)];
	_composePlaceholder.backgroundColor = [UIColor clearColor];
	[_composePlaceholder setTextColor:[UIColor lightGrayColor]];
	_composePlaceholder.font = [UIFont systemFontOfSize:36.0f];
	_composePlaceholder.text = @"Type emoji...";
	[self.view addSubview:_composePlaceholder];
	
	_emojiTextView = [[UITextView alloc] initWithFrame:CGRectMake(13.0, 72.0, 304.0, self.view.frame.size.height - 288)];
	_emojiTextView.backgroundColor = [UIColor clearColor];
	[_emojiTextView setAutocapitalizationType:UITextAutocapitalizationTypeNone];
	[_emojiTextView setAutocorrectionType:UITextAutocorrectionTypeNo];
	_emojiTextView.keyboardAppearance = UIKeyboardAppearanceDefault;
	[_emojiTextView setReturnKeyType:UIReturnKeyDone];
	[_emojiTextView setTextColor:[UIColor blackColor]];
	_emojiTextView.font = [UIFont systemFontOfSize:40.0f];
	_emojiTextView.keyboardType = UIKeyboardTypeDefault;
	_emojiTextView.text = @"";
	_emojiTextView.delegate = self;
	[self.view addSubview:_emojiTextView];
	
}

- (void)viewDidLoad {
	ViewControllerLog(@"[:|:] [%@ viewDidLoad] [:|:]", self.class);
	[super viewDidLoad];
	
	[[HONAnalyticsParams sharedInstance] trackEvent:@"Compose View - Entering"];
	
	if (![[[NSUserDefaults standardUserDefaults] objectForKey:@"in_compose"] isEqualToString:@"YES"]) {
		[[NSUserDefaults standardUserDefaults] setObject:@"YES" forKey:@"in_compose"];
		[[NSUserDefaults standardUserDefaults] synchronize];
		
		
		NSLog(@"^^^^^^IN COMPOSE MODAL^^^^^^");
	} //sets key to YES so that app knows it's in the compose modal already when resuming from background
}

- (void)viewDidAppear:(BOOL)animated {
	ViewControllerLog(@"[:|:] [%@ viewDidAppear:%@] [:|:]", self.class, [@"" stringFromBOOL:animated]);
	[super viewDidAppear:animated];
	
	[_emojiTextView becomeFirstResponder];
}



#pragma mark - Navigation
- (void)_goCancel {
	[[HONAnalyticsParams sharedInstance] trackEvent:@"Compose View - Cancel"];
	[[NSUserDefaults standardUserDefaults] setObject:@"NO" forKey:@"in_compose"];
	NSLog(@"^^^^^^NOT IN COMPOSE MODAL^^^^^^");
	
	[self dismissViewControllerAnimated:YES completion:^(void) {}];
}

- (void)_goSubmit {
	_isSubmitting = YES;
	[_emojiTextView resignFirstResponder];
}

#define ACCEPTABLE_CHARACTERS @"ğŸ˜„ğŸ˜ƒğŸ˜€ğŸ˜Šâ˜ºï¸ğŸ˜‰ğŸ˜ğŸ˜˜ğŸ˜šğŸ˜—ğŸ˜™ğŸ˜œğŸ˜ğŸ˜›ğŸ˜³ğŸ˜ğŸ˜”ğŸ˜ŒğŸ˜’ğŸ˜ğŸ˜£ğŸ˜¢ğŸ˜‚ğŸ˜­ğŸ˜ªğŸ˜¥ğŸ˜°ğŸ˜…ğŸ˜“ğŸ˜©ğŸ˜«ğŸ˜¨ğŸ˜±ğŸ˜ ğŸ˜¡ğŸ˜¤ğŸ˜–ğŸ˜†ğŸ˜‹ğŸ˜·ğŸ˜ğŸ˜´ğŸ˜µğŸ˜²ğŸ˜ŸğŸ˜¦ğŸ˜§ğŸ˜ˆğŸ‘¿ğŸ˜®ğŸ˜¬ğŸ˜ğŸ˜•ğŸ˜¯ğŸ˜¶ğŸ˜‡ğŸ˜ğŸ˜‘ğŸ‘²ğŸ‘³ğŸ‘®ğŸ‘·ğŸ’‚ğŸ‘¶ğŸ‘¦ğŸ‘§ğŸ‘¨ğŸ‘©ğŸ‘´ğŸ‘µğŸ‘±ğŸ‘¼ğŸ‘¸ğŸ˜ºğŸ˜¸ğŸ˜»ğŸ˜½ğŸ˜¼ğŸ™€ğŸ˜¿ğŸ˜¹ğŸ˜¾ğŸ‘¹ğŸ‘ºğŸ™ˆğŸ™‰ğŸ™ŠğŸ’€ğŸ‘½ğŸ’©ğŸ”¥âœ¨ğŸŒŸğŸ’«ğŸ’¥ğŸ’¢ğŸ’¦ğŸ’§ğŸ’¤ğŸ’¨ğŸ‘‚ğŸ‘€ğŸ‘ƒğŸ‘…ğŸ‘„ğŸ‘ğŸ‘ğŸ‘ŒğŸ‘ŠâœŠâœŒï¸ğŸ‘‹âœ‹ğŸ‘ğŸ‘†ğŸ‘‡ğŸ‘‰ğŸ‘ˆğŸ™ŒğŸ™â˜ï¸ğŸ‘ğŸ’ªğŸš¶ğŸƒğŸ’ƒğŸ‘«ğŸ‘ªğŸ‘¬ğŸ‘­ğŸ’ğŸ’‘ğŸ‘¯ğŸ™†ğŸ™…ğŸ’ğŸ™‹ğŸ’†ğŸ’‡ğŸ’…ğŸ‘°ğŸ™ğŸ™ğŸ™‡ğŸ©ğŸ‘‘ğŸ‘’ğŸ‘ŸğŸ‘ğŸ‘¡ğŸ‘ ğŸ‘¢ğŸ‘•ğŸ‘”ğŸ‘šğŸ‘—ğŸ½ğŸ‘–ğŸ‘˜ğŸ‘™ğŸ’¼ğŸ‘œğŸ‘ğŸ‘›ğŸ‘“ğŸ€ğŸŒ‚ğŸ’„ğŸ’›ğŸ’™ğŸ’œğŸ’šâ¤ï¸ğŸ’”ğŸ’—ğŸ’“ğŸ’•ğŸ’–ğŸ’ğŸ’˜ğŸ’ŒğŸ’‹ğŸ’ğŸ’ğŸ‘¤ğŸ‘¥ğŸ’¬ğŸ‘£ğŸ’­ğŸ¶ğŸºğŸ±ğŸ­ğŸ¹ğŸ°ğŸ¯ğŸ¨ğŸ»ğŸ·ğŸ½ğŸ®ğŸ—ğŸµğŸ’ğŸ´ğŸ‘ğŸ˜ğŸ¼ğŸ§ğŸ¦ğŸ¤ğŸ¥ğŸ£ğŸ”ğŸğŸ¢ğŸ›ğŸğŸœğŸğŸŒğŸ™ğŸšğŸ ğŸŸğŸ¬ğŸ³ğŸ‹ğŸ„ğŸğŸ€ğŸƒğŸ…ğŸ‡ğŸ‰ğŸğŸğŸ“ğŸ•ğŸ–ğŸğŸ‚ğŸ²ğŸ¡ğŸŠğŸ«ğŸªğŸ†ğŸˆğŸ©ğŸ¾ğŸ’ğŸŒ¸ğŸŒ·ğŸ€ğŸŒ¹ğŸŒ»ğŸŒºğŸğŸƒğŸ‚ğŸŒ¿ğŸŒ¾ğŸ„ğŸŒµğŸŒ´ğŸŒ²ğŸŒ³ğŸŒ°ğŸŒ±ğŸŒ¼ğŸŒğŸŒğŸŒğŸŒšğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜ğŸŒœğŸŒ›ğŸŒ™ğŸŒğŸŒğŸŒğŸŒ‹ğŸŒŒğŸŒ â­ï¸â˜€ï¸â›…ï¸â˜ï¸âš¡ï¸â˜”ï¸â„ï¸â›„ï¸ğŸŒ€ğŸŒğŸŒˆğŸŒŠğŸğŸ’ğŸğŸ’ğŸ“ğŸğŸ†ğŸ‡ğŸğŸ‘ğŸƒğŸ‘»ğŸ…ğŸ„ğŸğŸ‹ğŸ‰ğŸŠğŸˆğŸŒğŸ”®ğŸ¥ğŸ“·ğŸ“¹ğŸ“¼ğŸ’¿ğŸ“€ğŸ’½ğŸ’¾ğŸ’»ğŸ“±â˜ï¸ğŸ“ğŸ“ŸğŸ“ ğŸ“¡ğŸ“ºğŸ“»ğŸ”ŠğŸ”‰ğŸ”ˆğŸ”‡ğŸ””ğŸ”•ğŸ“¢ğŸ“£â³âŒ›ï¸â°âŒšï¸ğŸ”“ğŸ”’ğŸ”ğŸ”ğŸ”‘ğŸ”ğŸ’¡ğŸ”¦ğŸ”†ğŸ”…ğŸ”ŒğŸ”‹ğŸ”ğŸ›ğŸ›€ğŸš¿ğŸš½ğŸ”§ğŸ”©ğŸ”¨ğŸšªğŸš¬ğŸ’£ğŸ”«ğŸ”ªğŸ’ŠğŸ’‰ğŸ’°ğŸ’´ğŸ’µğŸ’·ğŸ’¶ğŸ’³ğŸ’¸ğŸ“²ğŸ“§ğŸ“¥ğŸ“¤âœ‰ï¸ğŸ“©ğŸ“¨ğŸ“¯ğŸ“«ğŸ“ªğŸ“¬ğŸ“­ğŸ“®ğŸ“¦ğŸ“ğŸ“„ğŸ“ƒğŸ“‘ğŸ“ŠğŸ“ˆğŸ“‰ğŸ“œğŸ“‹ğŸ“…ğŸ“†ğŸ“‡ğŸ“ğŸ“‚âœ‚ï¸ğŸ“ŒğŸ“âœ’ï¸âœï¸ğŸ“ğŸ“ğŸ“•ğŸ“—ğŸ“˜ğŸ“™ğŸ““ğŸ“”ğŸ“’ğŸ“šğŸ“–ğŸ”–ğŸ“›ğŸ”¬ğŸ”­ğŸ“°ğŸ¨ğŸ¬ğŸ¤ğŸ§ğŸ¼ğŸµğŸ¶ğŸ¹ğŸ»ğŸºğŸ·ğŸ¸ğŸ‘¾ğŸ®ğŸƒğŸ´ğŸ€„ï¸ğŸ²ğŸ¯ğŸˆğŸ€âš½ï¸âš¾ï¸ğŸ¾ğŸ±ğŸ‰ğŸ³â›³ï¸ğŸšµğŸš´ğŸğŸ‡ğŸ†ğŸ¿ğŸ‚ğŸŠğŸ„ğŸ£â˜•ï¸ğŸµğŸ¶ğŸ¼ğŸºğŸ»ğŸ¸ğŸ¹ğŸ·ğŸ´ğŸ•ğŸ”ğŸŸğŸ—ğŸ–ğŸğŸ›ğŸ¤ğŸ±ğŸ£ğŸ¥ğŸ™ğŸ˜ğŸšğŸœğŸ²ğŸ¢ğŸ¡ğŸ³ğŸğŸ©ğŸ®ğŸ¦ğŸ¨ğŸ§ğŸ‚ğŸ°ğŸªğŸ«ğŸ¬ğŸ­ğŸ¯ğŸğŸğŸŠğŸ‹ğŸ’ğŸ‡ğŸ‰ğŸ“ğŸ‘ğŸˆğŸŒğŸğŸğŸ ğŸ†ğŸ…ğŸŒ½ğŸ ğŸ¡ğŸ«ğŸ¢ğŸ£ğŸ¥ğŸ¦ğŸªğŸ©ğŸ¨ğŸ’’â›ªï¸ğŸ¬ğŸ¤ğŸŒ‡ğŸŒ†ğŸ¯ğŸ°â›ºï¸ğŸ­ğŸ—¼ğŸ—¾ğŸ—»ğŸŒ„ğŸŒ…ğŸŒƒğŸ—½ğŸŒ‰ğŸ ğŸ¡â›²ï¸ğŸ¢ğŸš¢â›µï¸ğŸš¤ğŸš£âš“ï¸ğŸš€âœˆï¸ğŸ’ºğŸšğŸš‚ğŸšŠğŸš‰ğŸšğŸš†ğŸš„ğŸš…ğŸšˆğŸš‡ğŸšğŸš‹ğŸšƒğŸšğŸšŒğŸšğŸš™ğŸš˜ğŸš—ğŸš•ğŸš–ğŸš›ğŸššğŸš¨ğŸš“ğŸš”ğŸš’ğŸš‘ğŸšğŸš²ğŸš¡ğŸšŸğŸš ğŸšœğŸ’ˆğŸšğŸ«ğŸš¦ğŸš¥âš ï¸ğŸš§ğŸ”°â›½ï¸ğŸ®ğŸ°â™¨ï¸ğŸ—¿ğŸªğŸ­ğŸ“ğŸš©ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡·ğŸ‡©ğŸ‡ªğŸ‡¨ğŸ‡³ğŸ‡ºğŸ‡¸ğŸ‡«ğŸ‡·ğŸ‡ªğŸ‡¸ğŸ‡®ğŸ‡¹ğŸ‡·ğŸ‡ºğŸ‡¬ğŸ‡§1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£4ï¸âƒ£5ï¸âƒ£6ï¸âƒ£7ï¸âƒ£8ï¸âƒ£9ï¸âƒ£0ï¸âƒ£ğŸ”ŸğŸ”¢#ï¸âƒ£ğŸ”£â¬†ï¸â¬‡ï¸â¬…ï¸â¡ï¸ğŸ” ğŸ”¡ğŸ”¤â†—ï¸â†–ï¸â†˜ï¸â†™ï¸â†”ï¸â†•ï¸ğŸ”„â—€ï¸â–¶ï¸ğŸ”¼ğŸ”½â†©ï¸â†ªï¸â„¹ï¸âªâ©â«â¬â¤µï¸â¤´ï¸ğŸ†—ğŸ”€ğŸ”ğŸ”‚ğŸ†•ğŸ†™ğŸ†’ğŸ†“ğŸ†–ğŸ“¶ğŸ¦ğŸˆğŸˆ¯ï¸ğŸˆ³ğŸˆµğŸˆ´ğŸˆ²ğŸ‰ğŸˆ¹ğŸˆºğŸˆ¶ğŸˆšï¸ğŸš»ğŸš¹ğŸšºğŸš¼ğŸš¾ğŸš°ğŸš®ğŸ…¿ï¸â™¿ï¸ğŸš­ğŸˆ·ğŸˆ¸ğŸˆ‚â“‚ï¸ğŸ›‚ğŸ›„ğŸ›…ğŸ›ƒğŸ‰‘ãŠ™ï¸ãŠ—ï¸ğŸ†‘ğŸ†˜ğŸ†”ğŸš«ğŸ”ğŸ“µğŸš¯ğŸš±ğŸš³ğŸš·ğŸš¸â›”ï¸âœ³ï¸â‡ï¸ââœ…âœ´ï¸ğŸ’ŸğŸ†šğŸ“³ğŸ“´ğŸ…°ğŸ…±ğŸ†ğŸ…¾ğŸ’ â¿â™»ï¸â™ˆï¸â™‰ï¸â™Šï¸â™‹ï¸â™Œï¸â™ï¸â™ï¸â™ï¸â™ï¸â™‘ï¸â™’ï¸â™“ï¸â›ğŸ”¯ğŸ§ğŸ’¹ğŸ’²ğŸ’±Â©Â®â„¢âŒâ€¼ï¸â‰ï¸â—ï¸â“â•â”â­•ï¸ğŸ”ğŸ”šğŸ”™ğŸ”›ğŸ”œğŸ”ƒğŸ•›ğŸ•§ğŸ•ğŸ•œğŸ•‘ğŸ•ğŸ•’ğŸ•ğŸ•“ğŸ•ŸğŸ•”ğŸ• ğŸ••ğŸ•–ğŸ•—ğŸ•˜ğŸ•™ğŸ•šğŸ•¡ğŸ•¢ğŸ•£ğŸ•¤ğŸ•¥ğŸ•¦âœ–ï¸â•â–â—â™ ï¸â™¥ï¸â™£ï¸â™¦ï¸ğŸ’®ğŸ’¯âœ”ï¸â˜‘ï¸ğŸ”˜ğŸ”—â°ã€°ã€½ï¸ğŸ”±â—¼ï¸â—»ï¸â—¾ï¸â—½ï¸â–ªï¸â–«ï¸ğŸ”ºğŸ”²ğŸ”³âš«ï¸âšªï¸ğŸ”´ğŸ”µğŸ”»â¬œï¸â¬›ï¸ğŸ”¶ğŸ”·ğŸ”¸ğŸ”¹"
#pragma mark - TextView Delegates
- (BOOL)textView:(UITextView *)textView shouldChangeTextInRange:(NSRange)range replacementText:(NSString *)text {
	
	
	NSCharacterSet *cs = [[NSCharacterSet characterSetWithCharactersInString:ACCEPTABLE_CHARACTERS] invertedSet];
	
	if([text isEqualToString:@"\n"]) {
		[textView resignFirstResponder];
		return NO;
	}
	
	if ([text rangeOfCharacterFromSet:cs].location != NSNotFound) {
		[[[UIAlertView alloc] initWithTitle:@"This app requires you to use the Emoji iOS 8 Keyboard!"
									message:nil
								   delegate:nil
						  cancelButtonTitle:NSLocalizedString(@"alert_ok", nil)
						  otherButtonTitles:nil] show];
		NSLog(@"This string contains illegal characters");
	}
	
	
	
	NSString *filtered = [[text componentsSeparatedByCharactersInSet:cs] componentsJoinedByString:@""];
	
	return ([text isEqualToString:filtered] && ([textView.text length] < 200));

	
	
//	NSLog(@"textView:[%@] shouldChangeTextInRange:[%@] replacementText:[%@] -- (%@)", textView.text, NSStringFromRange(range), text, NSStringFromRange([text rangeOfCharacterFromSet:cs]));
//	
//	_offset = ([text isEqualToString:filtered] && ([textView.text length] < 200)) ? [text length] : 0;
//	
	[[HONAnalyticsParams sharedInstance] trackEvent:[NSString stringWithFormat:@"Compose View - Enter %@Unicode Char", ([text isEqualToString:filtered]) ? @"" : @"Non-"] withStringChar:text];
	
	return (([text isEqualToString:filtered] && ([textView.text length] < 200)));
}

- (void)textViewDidChange:(UITextView *)textView {
	
	if ([textView.text length] > 0) {
		NSString *lastChar = [textView.text substringFromIndex: [textView.text length]-2];

		[_headerView setTitle: [textView.text substringFromIndex: [textView.text length]-2]];
		
		NSData *utf32 = [lastChar dataUsingEncoding:NSUTF32BigEndianStringEncoding]; //Unicode Code Point
		NSString *uniHex = [[[[[[utf32 description] substringWithRange:NSMakeRange(1, [[utf32 description] length] - 2)] componentsSeparatedByString:@" "] lastObject] substringFromIndex:3] uppercaseString];
		NSString *uniFormat = [@"U+" stringByAppendingString:uniHex];
		
		NSLog(@"Character (%@) = {%@}", lastChar, uniFormat);//@"\U0001F604");

	}
	
	else {
		[_headerView setTitle:@"Compose"];
	}
	
	_composePlaceholder.hidden = ([_emojiTextView.text length] > 0);
	
	
	
//	NSLog(@"textView:[%@](%u)--{%d}", textView.text, [textView.text length], _offset);
//	NSString *lastChar = ([textView.text length] > 0) ? [textView.text substringFromIndex:[textView.text length]  - _offset] : @"";
//	[_headerView setTitle:([lastChar length] > 0) ? lastChar : @"Compose"];
	

//	int codeValue = strtol([lastChar UTF8String], NULL, 16);
//	NSUInteger codeValue;
//	[[NSScanner scannerWithString:lastChar] scanHexInt:&codeValue];
//	NSLog(@"Character (%@) = [\\u%x] (%d)", lastChar, (unichar)codeValue, codeValue);

//	NSData *u = [lastChar dataUsingEncoding:NSUTF32StringEncoding]; //UTF-32LE (hex)
//	NSData *u = [lastChar dataUsingEncoding:NSUTF32LittleEndianStringEncoding]; //UTF-32LE (hex)
//	NSData *utf32 = [lastChar dataUsingEncoding:NSUTF32BigEndianStringEncoding]; //Unicode Code Point
//	NSString *uniHex = [[[[[[utf32 description] substringWithRange:NSMakeRange(1, [[utf32 description] length] - 2)] componentsSeparatedByString:@" "] lastObject] substringFromIndex:3] uppercaseString];
//	NSString *uniFormat = [@"U+" stringByAppendingString:uniHex];
	
//	NSString *emoji = [uniFormat substringFromIndex:[lastChar length]];
//	for (int i=0; i<8-[[uniFormat substringFromIndex:[lastChar length]] length]; i++)
//		emoji = [@"0" stringByAppendingString:emoji];
//	
//	NSLog(@"Character (%@) = [\\u%06x]/[U+%@] (%d) {%@}", lastChar, [lastChar characterAtIndex:0], uniHex, [lastChar characterAtIndex:0], emoji);//@"\U0001F604");
}

- (void)textViewDidBeginEditing:(UITextView *)textView {
	_isSubmitting = NO;
	_offset = 0;
}

- (void)textViewDidEndEditing:(UITextView *)textView {
	NSLog(@"textViewDidEndEditing");
	
	if (_isSubmitting) {
		if ([_emojiTextView.text length] > 0)
			[self _submitStatusUpdate];
		
		else {
			UIAlertView *alertView = [[UIAlertView alloc] initWithTitle:@"Need to choose an emoji!"
																message:nil
															   delegate:self
													  cancelButtonTitle:NSLocalizedString(@"alert_ok", nil)
													  otherButtonTitles:nil];
			[alertView setTag:0];
			[alertView show];
		}
	}

}

#pragma mark - AlertView Delegates
- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex {
	if (alertView.tag == 0) {
		[_emojiTextView becomeFirstResponder];
	}
	
	else if (alertView.tag == 1){
		NSLog(@"DID SUBMIT -> POP ALERT %d", buttonIndex);
		if (buttonIndex == 1) {
			NSLog(@"ALL CONTACTS");
		}
		if (buttonIndex == 2) {
			NSLog(@"ALL MOJI FRIENDS");
		}
		
		if(!(buttonIndex == 0)){
			[[HONClubAssistant sharedInstance] broadcastLastStatusUpdateToAllContacts: (buttonIndex == 1)];
			
			[self dismissViewControllerAnimated:YES completion:^(void) {
				[[NSNotificationCenter defaultCenter] postNotificationName:@"REFRESH_CONTACTS_TAB" object:@"Y"];
			}];
		}
	}
}

@end
